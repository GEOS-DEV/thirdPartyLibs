#------------------------------------------------------------------------------------------------------------
# SPDX-License-Identifier: LGPL-2.1-only
#
# Copyright (c) 2018-2020 Lawrence Livermore National Security LLC
# Copyright (c) 2018-2020 The Board of Trustees of the Leland Stanford Junior University
# Copyright (c) 2018-2020 TotalEnergies
# Copyright (c) 2019-     GEOSX Contributors
# All rights reserved
#
# See top level LICENSE, COPYRIGHT, CONTRIBUTORS, NOTICE, and ACKNOWLEDGEMENTS files for details.
#------------------------------------------------------------------------------------------------------------

# geosx@develop%cce@20.0.0
# geosx@develop%llvm-amdgpu_6_4_2
#
# Uberenv command to build geos dependencies:
# python3 ./scripts/uberenv/uberenv.py --spec="+rocm~pygeosx+hypre~trilinos~petsc~docs amdgpu_target=gfx942 %cce-20 ^vtk generator=ninja"
#
# python3 ./scripts/uberenv/uberenv.py --spec="+rocm~pygeosx+hypre~trilinos~petsc~docs amdgpu_target=gfx942 %llvm-amdgpu_6_4_2 ^vtk generator=ninja"


spack:
  config:
    install_tree:
      root: $spack/..
      projections:
        all: '{compiler.name}-{compiler.version}/{name}-{version}-{hash}'
    misc_cache: $spack/../misc_cache
    test_stage: $spack/../test_stage
    build_stage: $spack/../build_stage
    build_jobs: 96

  # Regular TPLs do not need views
  view: false

  # Include shared variants and versions
  include:
  - ../defaults.yaml
  - ../versions.yaml

  toolchains:
    llvm-amdgpu_6_4_2:
    - spec: '%c=llvm-amdgpu@6.4.2'
      when: '%c'
    - spec: '%cxx=llvm-amdgpu@6.4.2'
      when: '%cxx'
    - spec: '%fortran=llvm-amdgpu@6.4.2'
      when: '%fortran'
    - spec: '%cray-mpich@9.0.1_llvm_amdgpu'
      when: '%mpi'
    cce-20:
    - spec: '%c=cce@20.0.0'
      when: '%c'
    - spec: '%cxx=cce@20.0.0'
      when: '%cxx'
    - spec: '%fortran=cce@20.0.0'
      when: '%fortran'
    - spec: '%cray-mpich@9.0.1_cce'
      when: '%mpi'

  packages:
    all:
      providers:
        blas: [netlib-lapack]
        lapack: [netlib-lapack]
        mpi: [cray-mpich]
        zlib-api: [zlib]
        pkgconfig: [pkgconf]

    cce:
      externals:
      - spec: cce@=20.0.0
        prefix: /usr/tce/packages/cce-tce/cce-20.0.0
        extra_attributes:
          compilers:
            c: /usr/tce/packages/cce-tce/cce-20.0.0/bin/craycc
            cxx: /usr/tce/packages/cce-tce/cce-20.0.0/bin/crayCC
            fortran: /usr/tce/packages/cce-tce/cce-20.0.0/bin/crayftn
          flags: {}
          environment:
            set: # Needed for scotch
              BISON: bison
              FLEX: flex
          extra_rpaths:
          - /opt/cray/pe/mpich/9.0.1/ofi/crayclang/20.0/lib
          - /opt/cray/pe/mpich/9.0.1/gtl/lib
        modules:
        - PrgEnv-cray/8.6.0
        - craype-x86-genoa
        - craype/2.7.35
        - craype-network-ofi
        - craype-accel-amd-gfx942
        - cray-mpich/9.0.1
        - cray-libsci/25.09.0
        - cce/20.0.0
        - libfabric/2.1
        - flux_wrappers/0.1
        - StdEnv
        - perftools-base/25.09.0
        - xpmem/2.6.5


    llvm-amdgpu:
      externals:
      - spec: llvm-amdgpu@=6.4.2
        prefix: /opt/rocm-6.4.2/llvm
        extra_attributes:
          compilers:
            c: /opt/rocm-6.4.2/llvm/bin/amdclang
            cxx: /opt/rocm-6.4.2/llvm/bin/amdclang++
            fortran: /opt/rocm-6.4.2/llvm/bin/amdflang
          flags: {}
          environment:
            set: # Needed for scotch
              BISON: bison
              FLEX: flex
          extra_rpaths:
          - /opt/rocm-6.4.2/lib
          - /opt/rocm-6.4.2/llvm/lib
          - /opt/cray/pe/mpich/9.0.1/ofi/crayclang/20.0/lib
          - /opt/cray/pe/mpich/9.0.1/gtl/lib
        modules:
        - rocm/6.4.2
        - PrgEnv-cray/8.6.0
        - craype-x86-genoa
        - craype/2.7.35
        - craype-network-ofi
        - craype-accel-amd-gfx942
        - cray-mpich/9.0.1
        - cray-libsci/25.09.0
        - cce/20.0.0
        - libfabric/2.1
        - flux_wrappers/0.1
        - StdEnv
        - perftools-base/25.09.0
        - xpmem/2.6.5



    # Lock down which MPI we are using
    cray-mpich:
      buildable: false
      externals:
      - spec: cray-mpich@9.0.1_cce %cce@20.0.0
        # prefix: /usr/tce/packages/cray-mpich/cray-mpich-9.0.1-cce-20.0.0-magic
        prefix: /usr/tce/packages/cray-mpich-tce/cray-mpich-9.0.1-rocmcc-6.4.2-cce-20.0.0/
      - spec: cray-mpich@9.0.1_llvm_amdgpu %llvm-amdgpu@6.4.2
        # prefix: /usr/tce/packages/cray-mpich/cray-mpich-9.0.1-rocmcc-6.4.2-cce-20.0.0-magic
        prefix: /usr/tce/packages/cray-mpich-tce/cray-mpich-9.0.1-rocmcc-6.4.2/

    # ROCm packages
    hip:
      version: [6.4.0, 6.4.2]
      buildable: false
      externals:
      - spec: hip@6.4.0
        prefix: /opt/rocm-6.4.0
      - spec: hip@6.4.2
        prefix: /opt/rocm-6.4.2
    hipsparse:
      version: [6.4.0, 6.4.2]
      buildable: false
      externals:
      - spec: hipsparse@6.4.0
        prefix: /opt/rocm-6.4.0
      - spec: hipsparse@6.4.2
        prefix: /opt/rocm-6.4.2
    hipblas:
      version: [6.4.0, 6.4.2]
      buildable: false
      externals:
      - spec: hipblas@6.4.0
        prefix: /opt/rocm-6.4.0
      - spec: hipblas@6.4.2
        prefix: /opt/rocm-6.4.2
    hipblas-common:
      version: [6.4.0, 6.4.2]
      buildable: false
      externals:
      - spec: hipblas-common@6.4.0
        prefix: /opt/rocm-6.4.0
      - spec: hipblas-common@6.4.2
        prefix: /opt/rocm-6.4.2
    hipsolver:
      version: [6.4.0, 6.4.2]
      buildable: false
      externals:
      - spec: hipsolver@6.4.0
        prefix: /opt/rocm-6.4.0
      - spec: hipsolver@6.4.2
        prefix: /opt/rocm-6.4.2
    hsa-rocr-dev:
      version: [6.4.0, 6.4.2]
      buildable: false
      externals:
      - spec: hsa-rocr-dev@6.4.0
        prefix: /opt/rocm-6.4.0
      - spec: hsa-rocr-dev@6.4.2
        prefix: /opt/rocm-6.4.2
    rocminfo:
      version: [6.4.0, 6.4.2]
      buildable: false
      externals:
      - spec: rocminfo@6.4.0
        prefix: /opt/rocm-6.4.0
      - spec: rocminfo@6.4.2
        prefix: /opt/rocm-6.4.2
    rocm-device-libs:
      version: [6.4.0, 6.4.2]
      buildable: false
      externals:
      - spec: rocm-device-libs@6.4.0
        prefix: /opt/rocm-6.4.0
      - spec: rocm-device-libs@6.4.2
        prefix: /opt/rocm-6.4.2
    rocprim:
      version: [6.4.0, 6.4.2]
      buildable: false
      externals:
      - spec: rocprim@6.4.0
        prefix: /opt/rocm-6.4.0
      - spec: rocprim@6.4.2
        prefix: /opt/rocm-6.4.2
    rocthrust:
      version: [6.4.0, 6.4.2]
      buildable: false
      externals:
      - spec: rocthrust@6.4.0
        prefix: /opt/rocm-6.4.0
      - spec: rocthrust@6.4.2
        prefix: /opt/rocm-6.4.2
    rocsparse:
      version: [6.4.0, 6.4.2]
      buildable: false
      externals:
      - spec: rocsparse@6.4.0
        prefix: /opt/rocm-6.4.0
      - spec: rocsparse@6.4.2
        prefix: /opt/rocm-6.4.2
    rocrand:
      version: [6.4.0, 6.4.2]
      buildable: false
      externals:
      - spec: rocrand@6.4.0
        prefix: /opt/rocm-6.4.0
      - spec: rocrand@6.4.2
        prefix: /opt/rocm-6.4.2
    rocblas:
      version: [6.4.0, 6.4.2]
      buildable: false
      externals:
      - spec: rocblas@6.4.0
        prefix: /opt/rocm-6.4.0
      - spec: rocblas@6.4.2
        prefix: /opt/rocm-6.4.2
    rocsolver:
      version: [6.4.0, 6.4.2]
      buildable: false
      externals:
      - spec: rocsolver@6.4.0
        prefix: /opt/rocm-6.4.0
      - spec: rocsolver@6.4.2
        prefix: /opt/rocm-6.4.2
    rocm-core:
      version: [6.4.0, 6.4.2]
      buildable: false
      externals:
      - spec: rocm-core@6.4.0
        prefix: /opt/rocm-6.4.0
      - spec: rocm-core@6.4.2
        prefix: /opt/rocm-6.4.2

    # System level packages to not build
    python:
      buildable: false
      version: [3.9.12, 3.12.2]
      externals:
      - spec: python@3.9.12
        prefix: /usr/tce/packages/python/python-3.9.12
      - spec: python@3.12.2
        prefix: /usr/tce/packages/python/python-3.12.2
    papi:
      buildable: false
      version: [7.2.0.2]
      externals:
      - spec: papi@7.2.0.2
        prefix: /opt/cray/pe/papi/7.2.0.2
    cmake:
      version: [3.24.2, 3.29.2]
      buildable: false
      externals:
      - spec: cmake@3.24.2
        prefix: /usr/tce/packages/cmake/cmake-3.24.2
      - spec: cmake@3.29.2
        prefix: /usr/tce/packages/cmake/cmake-3.29.2
    autoconf:
      buildable: false
      externals:
      - spec: autoconf@2.69
        prefix: /usr
    automake:
      buildable: false
      externals:
      - spec: automake@1.16.1
        prefix: /usr
    binutils:
      buildable: false
      externals:
      - spec: binutils@2.30
        prefix: /usr
    bzip2:
      buildable: false
      externals:
      - spec: bzip2@1.0.6
        prefix: /usr
    curl:
      buildable: false
      externals:
      - spec: curl@7.61.1
        prefix: /usr
    diffutils:
      buildable: false
      externals:
      - spec: diffutils@3.6
        prefix: /usr
    elfutils:
      buildable: false
      externals:
      - spec: elfutils@0.190
        prefix: /usr
    findutils:
      buildable: false
      externals:
      - spec: findutils@4.6.0
        prefix: /usr
    gettext:
      buildable: false
      externals:
      - spec: gettext@0.19.8.1
        prefix: /usr
    ghostscript:
      buildable: false
      externals:
      - spec: ghostscript@9.27
        prefix: /usr
    graphviz:
      buildable: false
      externals:
      - spec: graphviz@2.40.1
        prefix: /usr
    groff:
      buildable: false
      externals:
      - spec: groff@1.22.3
        prefix: /usr
    #lapack
    netlib-lapack:
      buildable: false
      externals:
      - spec: netlib-lapack@3.8.0
        prefix: /usr
    libepoxy:
      buildable: false
      externals:
      - spec: libepoxy@1.5.8
        prefix: /usr
    libtool:
      buildable: false
      externals:
      - spec: libtool@2.4.6
        prefix: /usr
    libunwind:
      buildable: false
      externals:
      - spec: libunwind@1.3.1
        prefix: /usr
    libx11:
      buildable: false
      externals:
      - spec: libx11@1.6.8
        prefix: /usr
    libyogrt:
      externals:
      - spec: libyogrt@1.35 scheduler=flux
        prefix: /usr
      - spec: libyogrt@1.35 scheduler=slurm
        prefix: /usr
    lua:
      buildable: false
      externals:
      - spec: lua@5.3.4
        prefix: /usr
    gmake:
      buildable: false
      externals:
      - spec: gmake@4.2.1
        prefix: /usr
    m4:
      buildable: false
      externals:
      - spec: m4@1.4.18
        prefix: /usr
    ncurses:
      buildable: false
      externals:
      - spec: m4@6.2
        prefix: /usr
    perl:
      buildable: false
      externals:
      - spec: perl@5.26.3
        prefix: /usr
    pdsh:
      buildable: false
      externals:
      - spec: pdsh@2.35
        prefix: /usr
    pkgconf:
      buildable: false
      externals:
      - spec: pkgconf@1.4.2
        prefix: /usr
    readline:
      buildable: false
      externals:
      - spec: readline@7.0
        prefix: /usr
    tar:
      buildable: false
      externals:
      - spec: tar@1.30
        prefix: /usr
    unzip:
      buildable: false
      externals:
      - spec: unzip@6.0
        prefix: /usr
    zlib:
      buildable: false
      externals:
      - spec: zlib@1.2.11
        prefix: /usr
    ninja:
      buildable: false
      externals:
      - spec: ninja@1.10.2
        prefix: /usr/tce/packages/ninja/ninja-1.10.2
    flex:
      buildable: false
      externals:
      - spec: flex@2.6.1
        prefix: /usr
    bison:
      buildable: false
      externals:
      - spec: bison@3.0.4
        prefix: /usr
