#------------------------------------------------------------------------------------------------------------
# SPDX-License-Identifier: LGPL-2.1-only
#
# Copyright (c) 2018-2020 Lawrence Livermore National Security LLC
# Copyright (c) 2018-2020 The Board of Trustees of the Leland Stanford Junior University
# Copyright (c) 2018-2020 TotalEnergies
# Copyright (c) 2019-     GEOSX Contributors
# All rights reserved
#
# See top level LICENSE, COPYRIGHT, CONTRIBUTORS, NOTICE, and ACKNOWLEDGEMENTS files for details.
#------------------------------------------------------------------------------------------------------------

# Uberenv command to build geos dependencies:
#
# python3 ./scripts/uberenv/uberenv.py --spec="+docs %gcc-12"
#
# python3 ./scripts/uberenv/uberenv.py --spec="+docs %gcc-13"
#
# python3 ./scripts/uberenv/uberenv.py --spec="+docs %clang-14"
#
# python3 ./scripts/uberenv/uberenv.py --spec="+docs %clang-19"
#
# python3 ./scripts/uberenv/uberenv.py --spec="+cuda~uncrustify cuda_arch=90 %gcc-12 ^cuda@12.6.0+allow-unsupported-compilers"
#
# python3 ./scripts/uberenv/uberenv.py --spec="+cuda~uncrustify cuda_arch=90 %gcc-13 ^cuda@12.9.1+allow-unsupported-compilers"
#
# python3 ./scripts/uberenv/uberenv.py --spec="+cuda~uncrustify cuda_arch=90 %clang-14 ^cuda@12.6.0+allow-unsupported-compilers"
#
# python3 ./scripts/uberenv/uberenv.py --spec="+cuda~uncrustify cuda_arch=90 %clang-19 ^cuda@12.9.1+allow-unsupported-compilers"
#
#
# No AVX instructions:
# python3 ./scripts/uberenv/uberenv.py --spec="+docs %gcc-12-noAVX"
#

spack:
  config:
    install_tree:
      root: $spack/..
      projections:
        all: '{compiler.name}-{compiler.version}/{name}-{version}-{hash}'
    misc_cache: $spack/../misc_cache
    test_stage: $spack/../test_stage
    build_stage: $spack/../build_stage
    build_jobs: 112

  # Regular TPLs do not need views
  view: false

  # Include shared variants and versions
  include:
  - ../defaults.yaml
  - ../versions.yaml

  toolchains:
    clang-19:
    - spec: '%c=llvm@19.1.3'
      when: '%c'
    - spec: '%cxx=llvm@19.1.3'
      when: '%cxx'
    - spec: '%fortran=gcc@13.3.1'
      when: '%fortran'
    - spec: '%mvapich2@2.3.7.clang_19'
      when: '%mpi'
    clang-14:
    - spec: '%c=llvm@14.0.6'
      when: '%c'
    - spec: '%cxx=llvm@14.0.6'
      when: '%cxx'
    - spec: '%fortran=gcc@10.3.1'
      when: '%fortran'
    - spec: '%mvapich2@2.3.7.clang_14'
      when: '%mpi'
    gcc-12:
    - spec: '%c=gcc@12.1.1'
      when: '%c'
    - spec: '%cxx=gcc@12.1.1'
      when: '%cxx'
    - spec: '%fortran=gcc@12.1.1'
      when: '%fortran'
    - spec: '%mvapich2@2.3.7.gcc'
      when: '%mpi'
    gcc-12-noAVX:
    - spec: cxxflags='-march=x86-64-v2 -mno-avx512f'
    - spec: '%c=gcc@12.1.1'
      when: '%c'
    - spec: '%cxx=gcc@12.1.1'
      when: '%cxx'
    - spec: '%fortran=gcc@12.1.1'
      when: '%fortran'
    - spec: '%mvapich2@2.3.7.gcc'
      when: '%mpi'
    gcc-13:
    - spec: '%c=gcc@13.3.1'
      when: '%c'
    - spec: '%cxx=gcc@13.3.1'
      when: '%cxx'
    - spec: '%fortran=gcc@13.3.1'
      when: '%fortran'
    - spec: '%mvapich2@2.3.7.gcc'
      when: '%mpi'
    gcc-13-noAVX:
    - spec: cxxflags='-march=x86-64-v2 -mno-avx512f'
    - spec: '%c=gcc@13.3.1'
      when: '%c'
    - spec: '%cxx=gcc@13.3.1'
      when: '%cxx'
    - spec: '%fortran=gcc@13.3.1'
      when: '%fortran'
    - spec: '%mvapich2@2.3.7.gcc'
      when: '%mpi'

  packages:
    all:
      target: [sapphirerapids]

    mpi:
      require:
      - mvapich2

    zlib-api:
      require:
      - zlib

    blas:
      require:
      - "openblas"
    lapack:
      require:
      - "openblas"

    # Compilers
    llvm:
      externals:
      - spec: llvm@14.0.6+clang~flang~lld~lldb
        prefix: /usr/tce/packages/clang/clang-14.0.6-magic/
        extra_attributes:
          compilers:
            c: /usr/tce/packages/clang/clang-14.0.6-magic/bin/clang
            cxx: /usr/tce/packages/clang/clang-14.0.6-magic/bin/clang++
          extra_rpaths: []
      - spec: llvm@19.1.3+clang~lld~lldb
        prefix: /usr/tce/packages/clang/clang-19.1.3
        extra_attributes:
          compilers:
            c: /usr/tce/packages/clang/clang-19.1.3-magic/bin/clang
            cxx: /usr/tce/packages/clang/clang-19.1.3-magic/bin/clang++
          flags: {}
    gcc:
      externals:
      - spec: gcc@10.3.1 languages:='c,c++,fortran'
        prefix: /usr/tce/packages/gcc/gcc-10.3.1
        extra_attributes:
          compilers:
            c: /usr/tce/packages/gcc/gcc-10.3.1/bin/gcc
            cxx: /usr/tce/packages/gcc/gcc-10.3.1/bin/g++
            fortran: /usr/tce/packages/gcc/gcc-10.3.1/bin/gfortran
          flags: {}
          environment: {}
          extra_rpaths: []
      - spec: gcc@12.1.1 languages:=c,c++,fortran
        prefix: /usr/tce/packages/gcc/gcc-12.1.1-magic/
        extra_attributes:
          compilers:
            c: /usr/tce/packages/gcc/gcc-12.1.1-magic/bin/gcc
            cxx: /usr/tce/packages/gcc/gcc-12.1.1-magic/bin/g++
            fortran: /usr/tce/packages/gcc/gcc-12.1.1-magic/bin/gfortran
          extra_rpaths: []
      - spec: gcc@13.3.1 languages:=c,c++,fortran
        prefix: /usr/tce/packages/gcc/gcc-13.3.1-magic/
        extra_attributes:
          compilers:
            c: /usr/tce/packages/gcc/gcc-13.3.1-magic/bin/gcc
            cxx: /usr/tce/packages/gcc/gcc-13.3.1-magic/bin/g++
            fortran: /usr/tce/packages/gcc/gcc-13.3.1-magic/bin/gfortran
          extra_rpaths: []

    gcc-runtime:
      buildable: False
      externals:
      - spec: gcc-runtime@13.3.1
        prefix: /usr/tce/packages/gcc/gcc-13.3.1/lib/gcc/x86_64-redhat-linux/13
      - spec: gcc-runtime@12.1.1
        prefix: /usr/tce/packages/gcc/gcc-12.1.1/lib/gcc/x86_64-redhat-linux/12
      - spec: gcc-runtime@11.2.1
        prefix: /usr/tce/packages/gcc/gcc-11.2.1/lib/gcc/x86_64-redhat-linux/11

    # Lock down which MPI we are using
    mvapich2:
      buildable: False
      externals:
        - spec: mvapich2@2.3.7.gcc process_managers=slurm %gcc@12.1.1
          prefix: /usr/tce/packages/mvapich2/mvapich2-2.3.7-gcc-12.1.1-magic
        - spec: mvapich2@2.3.7.gcc process_managers=slurm %gcc@13.3.1
          prefix: /usr/tce/packages/mvapich2/mvapich2-2.3.7-gcc-13.3.1-magic
        - spec: mvapich2@2.3.7.clang_14 process_managers=slurm %llvm@14.0.6
          prefix:  /usr/tce/packages/mvapich2/mvapich2-2.3.7-clang-14.0.6-magic
        - spec: mvapich2@2.3.7.clang_19 process_managers=slurm %llvm@19.1.3
          prefix: /usr/tce/packages/mvapich2/mvapich2-2.3.7-clang-19.1.3

    # Spack issue prevents compilation: https://github.com/spack/spack/issues/49994
    # intel-oneapi-mkl:
    #   externals:
    #     - spec: intel-oneapi-mkl@2022.1.0 threads=openmp %gcc@12.1.1
    #       prefix: /usr/tce/packages/mkl/mkl-2022.1.0/
    #   buildable: False

    cuda:
      buildable: False
      externals:
      - spec: cuda@12.6.0 +allow-unsupported-compilers
        prefix: /usr/tce/packages/cuda/cuda-12.6.0
      - spec: cuda@12.9.1 +allow-unsupported-compilers
        prefix: /usr/tce/packages/cuda/cuda-12.9.1

    # System level packages to not build
    papi:
      buildable: False
      externals:
        - spec: papi@6.0.0.1
          prefix: /usr/tce/packages/papi/papi-6.0.0.1/
    cmake:
      version: [3.26.3]
      buildable: false
      externals:
      - spec: cmake@3.26.3
        prefix: /usr/tce/packages/cmake/cmake-3.26.3
    readline:
      externals:
      - spec: readline@7.0
        prefix: /collab/usr/gapps/python/build/spack-toss3.3/opt/spack/linux-rhel7-x86_64/gcc-4.9.3/readline-7.0-e5jqqjmcjknidgwvi353pd6umpixzxr2
      buildable: false
    m4:
      buildable: False
      externals:
        - spec: m4@1.4.18
          prefix: /usr
    perl:
      buildable: false
      externals:
      - spec: perl@5.26.3
        prefix: /usr
    pkg-config:
      buildable: false
      externals:
      - spec: pkg-config@1.8.0
        prefix: /usr
    diffutils:
      buildable: False
      externals:
        - spec: diffutils@3.3
          prefix: /usr/bin
    # This needs to be the prefix to the pygeosx LC installation
    # or system install with pygeosx dependencies
    python:
      buildable: False
      externals:
      - spec: python@3.10.8
        prefix: /usr/gapps/GEOSX/thirdPartyLibs/python/quartz-gcc-python/python/

    # This needs to be the prefix to the pygeosx LC installation
    # or system install with pygeosx dependencies
    py-sphinx:
      buildable: False
      externals:
      - spec: py-sphinx@1.6.3
        prefix: /usr/gapps/GEOSX/thirdPartyLibs/python/quartz-gcc-python/python/
    autoconf:
      buildable: False
      externals:
        - spec: autoconf@2.69
          prefix: /usr
    automake:
      buildable: False
      externals:
        - spec: automake@1.16.1
          prefix: /usr
    libtool:
      buildable: False
      externals:
        - spec: libtool@2.4.6
          prefix: /usr
    gettext:
      buildable: False
      externals:
        - spec: gettext@0.19.8.1
          prefix: /usr/bin/
    openblas:
      buildable: false
      externals:
      - prefix: /usr
        spec: openblas@0.3.15
    zlib:
      buildable: false
      externals:
      - spec: zlib@1.2.11
        prefix: /usr
    ninja:
      buildable: false
      externals:
      - spec: ninja@1.11.1
        prefix: /usr/tce/packages/ninja/ninja-1.11.1
    bison:
      buildable: false
      externals:
      - spec: bison@3.8.2
        prefix: /collab/usr/gapps/python/build/spack-toss4.1/opt/spack/linux-rhel8-ivybridge/gcc-10.3.1/bison-3.8.2-ihsbaayrrhbmxufyobmimzq3lhxxdbck/
    # Avoid using external flex - issues compiling scotch
    # flex:
    #   buildable: false
    #   externals:
    #   - spec: flex@2.6.1
    #     prefix: /usr
