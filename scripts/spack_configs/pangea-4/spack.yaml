# This is a Spack Environment file for Pangea-4.
#
# It describes a set of packages to be installed, along with
# configuration settings.
#
# Run command from the top-level of the repository:
# ./scripts/uberenv/uberenv.py                                  \
#    --spec "~openmp~pygeosx+docs %gcc-12"                      \
#    --spack-env-file=scripts/spack_configs/pangea-4/spack.yaml \
#    --project-json=.uberenv_config.json                        \
#    --prefix ${GEOS_TPL_DIR}
spack:
  config:
    install_tree:
      root: $spack/..
      projections:
        all: '{compiler.name}-{compiler.version}/{name}-{version}-{hash}'
    misc_cache: $spack/../misc_cache
    test_stage: $spack/../test_stage
    build_stage: $spack/../build_stage

  # Regular TPLs do not need views
  view: false

  # Include shared variants and versions
  include:
  - ../defaults.yaml
  - ../versions.yaml

  ################
  # TOOLCHAINS   #
  ################
  toolchains:
    gcc-12:
    - spec: '%c=gcc@12.2.1'
      when: '%c'
    - spec: '%cxx=gcc@12.2.1'
      when: '%cxx'
    - spec: '%fortran=gcc@12.2.1'
      when: '%fortran'
    - spec: '%hpcx-mpi@2.20.0'
      when: '%mpi'

  #############
  # PACKAGES  #
  #############
  packages:
    all:
      target: [znver3]

    # Ensure concretizer uses external MPI/BLAS/LAPACK implementation
    mpi:
      require:
      - hpcx-mpi
      buildable: false
    blas:
      require:
      - "intel-oneapi-mkl"
      buildable: false
    lapack:
      require:
      - "intel-oneapi-mkl"
      buildable: false

    ####
    # packages necessary on pangea4 when +grpc configuration is requested
    protobuf:
      require: "@21.1"
    grpc:
      require: "@1.64.0-full-clone"

    ####
    # external compiler
    gcc:
      externals:
      - spec: gcc@12.2.1 languages=c,c++,fortran +binutils
        prefix: /opt/rh/gcc-toolset-12/root/usr
        extra_attributes:
          compilers:
            c: /opt/rh/gcc-toolset-12/root/usr/bin/gcc
            cxx: /opt/rh/gcc-toolset-12/root/usr/bin/g++
            fortran: /opt/rh/gcc-toolset-12/root/usr/bin/gfortran
          flags:
            cflags: -march=native -mtune=native
            cxxflags: -march=native -mtune=native
          operating_system: rhel8
          target: x86_64
          extra_rpaths: []
      buildable: false

    ####
    # specs of spack packages to reuse
    bison:
      buildable: false
      externals:
      - spec: bison@3.8.2
        prefix: /lustre/p4scratch/data_local/sw/RHEL8/spack-0.21.0/opt/gcc-12.2.1/bison-3.8.2-ozy3z5u
    intel-oneapi-mkl:
      externals:
        - spec: intel-oneapi-mkl@2023.2.0%gcc@12.2.1
          prefix: /lustre/p4scratch/data_local/sw/RHEL8/spack-0.21.0/opt/gcc-12.1/intel-oneapi-mkl-2023.2.0-7kkfgmz
      buildable: false
    python:
      externals:
      - spec: python@3.11.6
        prefix: /lustre/p4scratch/data_local/sw/RHEL8/spack-0.21.0/opt/gcc-8.5.0/python-3.11.6-75o2uch
      buildable: false
    cmake:
      externals:
      - spec: cmake@3.27.2
        prefix: /lustre/p4scratch/data_local/sw/RHEL8/spack-0.21.0/opt/gcc-8.5.0/cmake-3.27.2-ph2542p
      buildable: false
    berkeley-db:
      externals:
      - spec: berkeley-db@18.1.40
        prefix: /lustre/p4scratch/data_local/sw/RHEL8/spack-0.21.0/opt/gcc-12.1/berkeley-db-18.1.40-uoxwqaw
      buildable: false
    pugixml:
      externals:
      - spec: pugixml@1.13~ipo+pic~shared
        prefix: /lustre/p4scratch/data_local/sw/RHEL8/spack-0.21.0/opt/gcc-12.1/pugixml-1.13-3lpqjua
      buildable: false
    perl:
      externals:
      - spec: perl@5.38.0
        prefix: /lustre/p4scratch/data_local/sw/RHEL8/spack-0.21.0/opt/gcc-12.1/perl-5.38.0-4sckw56
      buildable: false
    libiconv:
      externals:
      - spec: libiconv@1.17
        prefix: /lustre/p4scratch/data_local/sw/RHEL8/spack-0.21.0/opt/gcc-12.1/libiconv-1.17-2vpp7pm
      buildable: false
    mpfr:
      externals:
      - spec: mpfr@4.2.0
        prefix: /lustre/p4scratch/data_local/sw/RHEL8/spack-0.21.0/opt/gcc-12.1/mpfr-4.2.0-utwz5tl
      buildable: false
    gmp:
      externals:
      - spec: gmp@6.2.1
        prefix: /lustre/p4scratch/data_local/sw/RHEL8/spack-0.21.0/opt/gcc-12.1/gmp-6.2.1-pwaztmh
      buildable: false
    flex:
      externals:
      - spec: flex@2.6.3
        prefix: /lustre/p4scratch/data_local/sw/RHEL8/spack-0.21.0/opt/gcc-8.5.0/flex-2.6.3-xyx4nx4
      buildable: false
    doxygen:
      externals:
      - spec: doxygen@1.8.20
        prefix: /lustre/p4scratch/data_local/sw/RHEL8/spack-0.21.0/opt/gcc-12.2.1/doxygen-1.8.20-idfxpwl
      buildable: false

    ####
    # spec of system packages to reuse

    # bin
    gettext:
      externals:
        - spec: gettext@0.19.8.1
          prefix: /usr
      buildable: false
    git:
      externals:
      - spec: git@2.39.3~tcltk
        prefix: /usr
      buildable: false
    gmake:
      externals:
      - spec: gmake@4.2.1
        prefix: /usr
      buildable: false
    m4:
      externals:
      - spec: m4@1.4.18
        prefix: /usr
      buildable: false
    xz:
      externals:
      - spec: xz@5.2.4
        prefix: /usr
      buildable: false
    # libs
    glibc:
      externals:
      - spec: glibc@2.28
        prefix: /usr
      buildable: false
    hpcx-mpi:
      externals:
      - spec: hpcx-mpi@2.20.0
        prefix: /lustre/p4scratch/data_local/sw/RHEL8/hpcx/2.20.0/ompi
      buildable: false
    pkgconf:
      externals:
      - spec: pkgconf@1.4.2
        prefix: /usr
      buildable: false
    readline:
      buildable: false
      externals:
      - spec: readline@7.0
        prefix: /usr
    zlib:
      externals:
      - spec: zlib@1.2.11
        prefix: /usr
      buildable: false
